{% extends 'student_template/base_template.html' %}

{% block page_title %}
Select Subjects
{% endblock page_title %}

{% block main_content %}
<section class="content">
  <div class="container-fluid">
    <h3 class="mb-4">Select Subjects (Max 36 Credit Hours)</h3>

    {% if not advisor %}
    <div class="alert alert-warning" role="alert">
      ⚠️ You do not have an assigned academic advisor yet. You cannot submit your subject selections until one is assigned.
    </div>
    {% endif %}

    {% if not registration_open %}
    <div class="alert alert-warning" role="alert">
      ⚠️ The subject registration period is currently closed. You cannot make changes at this time.
    </div>
    {% endif %}

    {% if messages %}
      {% for message in messages %}
        <div class="alert {% if message.tags == 'success' %} alert-success {% elif message.tags == 'error' or message.tags == 'info' %} alert-danger {% endif %} alert-dismissible fade show mt-3" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}

    <!-- Student Info -->
    <div class="card mb-4">
      <div class="card-header bg-info text-white">
        <h5 class="card-title mb-0">Student Information</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <p><strong>Full Name:</strong> {{ user.first_name }} {{ user.last_name }}</p>
            <p><strong>Student ID:</strong> {{ user.id }}</p>
          </div>
          <div class="col-md-6">
            <p><strong>Student Year:</strong> {{ student_year }}<sup>th</sup> Year</p>
            <p><strong>Semester:</strong>
              {% if student_semester == 1 %}
                Fall Semester
              {% else %}
                Spring Semester
              {% endif %}
            </p>
            <p><strong>GPA:</strong> {{ cumulative_gpa }}</p>
          </div>
        </div>
      </div>
    </div>

    <form method="POST" action="{% url 'save_selected_subjects' %}" id="subjectForm">
      {% csrf_token %}

      <!-- Compulsory Subjects -->
      <h4>Compulsory Subjects</h4>
      <div class="card mb-4">
        <div class="card-body table-responsive p-0">
          <table class="table table-hover text-nowrap">
            <thead>
              <tr>
                <th>#</th>
                <th>Course Code</th>
                <th>Course Title</th>
                <th>Credit</th>
                <th>ECTS</th>
                <th>Type</th>
                <th>Semester</th>
                <th>Select</th>
              </tr>
            </thead>
            <tbody>
              {% for subject in compulsory_subjects %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ subject.subject_code }}</td>
                <td>{{ subject.subject_name }}</td>
                <td>{{ subject.credit_hours }}</td>
                <td>{{ subject.ects_credits }}</td>
                <td>{{ subject.subject_type }}</td>
                <td>{{ subject.semester }}</td>
                <td>
                  <input type="checkbox" name="subjects" value="{{ subject.id }}" class="subject-checkbox"
                         data-credits="{{ subject.credit_hours }}"
                         {% if subject.id in selected_subjects %} checked {% endif %}
                         {% if not registration_open or not advisor %} disabled {% endif %}>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Elective Subjects -->
      <h4>Elective Subjects (Max: {{ max_electives }})</h4>
      <div class="card mb-4">
        <div class="card-body table-responsive p-0">
          <table class="table table-hover text-nowrap">
            <thead>
              <tr>
                <th>#</th>
                <th>Course Code</th>
                <th>Course Title</th>
                <th>Credit</th>
                <th>ECTS</th>
                <th>Type</th>
                <th>Semester</th>
                <th>Select</th>
              </tr>
            </thead>
            <tbody>
              {% for subject in elective_subjects %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ subject.subject_code }}</td>
                <td>{{ subject.subject_name }}</td>
                <td>{{ subject.credit_hours }}</td>
                <td>{{ subject.ects_credits }}</td>
                <td>{{ subject.subject_type }}</td>
                <td>{{ subject.semester }}</td>
                <td>
                  <input type="checkbox" name="subjects" value="{{ subject.id }}"
                         class="subject-checkbox elective-checkbox"
                         data-credits="{{ subject.credit_hours }}"
                         {% if subject.id in selected_subjects %} checked {% endif %}
                         {% if not registration_open or not advisor %} disabled {% endif %}>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Recommended Elective Subjects -->
      {% if recommended_subjects %}
      <h4 class="mt-4"> Recommended Elective Subjects</h4>
      <div class="card border border-primary shadow-sm mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <span><i class="bi bi-stars"></i> Personalized Recommendations</span>
          <small>AI-based Suggestions</small>
        </div>
        <div class="card-body table-responsive p-0">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>Code</th>
                <th>Title</th>
                <th>Credit</th>
                <th>ECTS</th>
                <th>Semester</th>
                <th><i class="bi bi-check-circle"></i> Select</th>
              </tr>
            </thead>
            <tbody>
              {% for subject in recommended_subjects %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td><span class="badge bg-info text-dark">{{ subject.subject_code }}</span></td>
                <td>{{ subject.subject_name }}</td>
                <td>{{ subject.credit_hours }}</td>
                <td>{{ subject.ects_credits }}</td>
                <td>{{ subject.semester }}</td>
                <td>
                  <input type="checkbox" name="subjects" value="{{ subject.id }}"
                         class="form-check-input subject-checkbox elective-checkbox"
                         data-credits="{{ subject.credit_hours }}">
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}

      <!-- Credit Counter -->
      <div class="mt-3">
        <p><strong>Total Selected Credit Hours:</strong> <span id="totalCredits">0</span> / 36</p>
      </div>

      <button type="submit" class="btn btn-primary mt-2" id="submitButton"
              {% if not registration_open or not advisor %}disabled{% endif %}>
        Submit Selected Subjects
      </button>
    </form>

    <!-- Registration Status -->
    <h4 class="mt-5">Your Subject Registration Status</h4>
    <table class="table table-bordered mt-3">
      <thead>
        <tr>
          <th>#</th>
          <th>Course Code</th>
          <th>Course Title</th>
          <th>Credit</th>
          <th>ECTS</th>
          <th>Type</th>
          <th>Semester</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for sub in approved_subjects %}
        <tr>
          <td>{{ forloop.counter }}</td>
          <td>{{ sub.subject.subject_code }}</td>
          <td>{{ sub.subject.subject_name }}</td>
          <td>{{ sub.subject.credit_hours }}</td>
          <td>{{ sub.subject.ects_credits }}</td>
          <td>{{ sub.subject.subject_type }}</td>
          <td>{{ sub.subject.semester }}</td>
          <td>
            {% if sub.is_approved == True %}
              <span class="badge bg-success">Approved</span>
            {% elif sub.is_approved == False %}
              <span class="badge bg-danger">Rejected</span>
            {% else %}
              <span class="badge bg-warning text-dark">Pending</span>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" class="text-center">No subjects submitted yet.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const checkboxes = document.querySelectorAll('.subject-checkbox');
  const totalCreditsSpan = document.getElementById('totalCredits');
  const submitButton = document.getElementById('submitButton');
  const electiveCheckboxes = document.querySelectorAll('.elective-checkbox');
  const maxElectives = {{ max_electives }};
  let totalCredits = 0;

  function updateCredits() {
    totalCredits = 0;
    checkboxes.forEach(checkbox => {
      if (checkbox.checked) {
        totalCredits += parseFloat(checkbox.getAttribute('data-credits')) || 0;
      }
    });

    totalCreditsSpan.textContent = totalCredits;

    if (totalCredits > 36) {
      alert("⚠️ You cannot select more than 36 Credit Hours.");
      submitButton.disabled = true;
    } else {
      if ({{ advisor|yesno:"true,false" }} && {{ registration_open|yesno:"true,false" }}) {
        submitButton.disabled = false;
      }
    }
  }

  function enforceElectiveLimit() {
    const selectedElectives = [...electiveCheckboxes].filter(cb => cb.checked);
    if (selectedElectives.length > maxElectives) {
      alert(`⚠️ You can select only ${maxElectives} elective subject(s).`);
      selectedElectives[selectedElectives.length - 1].checked = false;
    }
  }

  checkboxes.forEach(cb => {
    cb.addEventListener('change', updateCredits);
  });

  electiveCheckboxes.forEach(cb => {
    cb.addEventListener('change', enforceElectiveLimit);
  });

  updateCredits();
});
</script>
{% endblock main_content %}
